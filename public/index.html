<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Electronic | Training Portal</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">

    <style>
        /* --- STYLES SAME AS BEFORE --- */
        :root { --primary: #004aad; --secondary: #002f6c; --accent: #ff6b35; --light: #f4f7f6; --dark: #333333; --white: #ffffff; --danger: #dc3545; --success: #28a745; --shadow: 0 4px 15px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--white); color: var(--dark); line-height: 1.6; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        .btn { background: var(--primary); color: var(--white); padding: 0.7rem 1.5rem; border-radius: 5px; font-weight: 600; cursor: pointer; border: none; transition: 0.3s; }
        .btn:hover { background: var(--secondary); }
        .btn-danger { background: var(--danger); } .btn-danger:hover { background: #c82333; }
        .btn-success { background: var(--success); } .btn-success:hover { background: #218838; }
        header { background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); text-transform: uppercase; }
        .nav-links { display: flex; gap: 2rem; }
        .hero { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: var(--white); padding: 5rem 2rem; text-align: center; }
        .hero h1 { font-size: 3rem; margin-bottom: 1rem; }
        .section { padding: 4rem 2rem; }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { color: var(--primary); font-size: 2.5rem; }
        .pricing-grid { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
        .pricing-card { background: var(--white); padding: 2.5rem; border-radius: 15px; box-shadow: var(--shadow); border-top: 5px solid var(--primary); width: 380px; display: flex; flex-direction: column; justify-content: space-between; }
        .pricing-card h3 { text-align: center; color: var(--secondary); margin-bottom: 5px; }
        .price-tag { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; display: block; text-align: center; }
        .price-sub { text-align: center; color: #666; font-weight: 600; margin-bottom: 20px; font-size: 1.1rem; }
        .course-features { text-align: left; margin: 0 0 25px 0; padding: 0; }
        .course-features li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; color: #555; display: flex; align-items: flex-start; }
        .course-features li::before { content: "✓"; color: var(--success); font-weight: bold; margin-right: 10px; min-width: 15px; }
        .admin-header { background: var(--dark); color: var(--white); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .admin-table-container { padding: 2rem; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: var(--shadow); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary); color: white; }
        tr:hover { background-color: #f1f1f1; }
        .badge-pending { background: #ffc107; color: #333; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-confirmed { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #888; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .flatpickr-input { background-color: #fff; cursor: pointer; }
    </style>
</head>
<body>

    <div id="user-view">
        <header>
            <div class="nav-container">
                <div class="logo">Mr. Electronic</div>
                <nav class="nav-links">
                    <a href="#curriculum">Curriculum</a>
                    <a href="#training">Training</a>
                </nav>
                <a href="#contact" class="btn">Contact Us</a>
            </div>
        </header>

        <section class="hero">
            <h1>Master Electronics Design</h1>
            <p>From Schematic to PCB Assembly. Book your training slot today.</p>
        </section>

        <section id="training" class="section">
            <div class="section-title">
                <h2>Select Training Camp</h2>
                <p>Choose the course that fits your learning goals</p>
            </div>
            
            <div class="pricing-grid">
                <div class="pricing-card">
                    <div>
                        <h3>Crash Course</h3>
                        <span class="price-tag">1 Week Camp</span>
                        <div class="price-sub">₹2600 / Candidate</div>
                        <ul class="course-features">
                            <li>Basics of Electronics</li>
                            <li>Schematics Design</li>
                            <li>High Level Layout Design</li>
                            <li>Validation</li>
                            <li>Output Generation</li>
                        </ul>
                    </div>
                    <button onclick="openBooking('1 Week Crash Course', 7, 2600)" class="btn" style="width: 100%;">Book Slots</button>
                </div>
                
                <div class="pricing-card">
                    <div>
                        <h3>Master Class</h3>
                        <span class="price-tag">2 Week Camp</span>
                        <div class="price-sub">₹3000 / Candidate</div>
                        <ul class="course-features">
                            <li>Basics of Electronics</li>
                            <li>Schematics Design (2x Boards)</li>
                            <li>Schematics Review & Layout</li>
                            <li>Integration & Validation</li>
                            <li>Output Generation</li>
                        </ul>
                    </div>
                    <button onclick="openBooking('2 Week Master Class', 14, 3000)" class="btn" style="width: 100%;">Book Slots</button>
                </div>
            </div>
        </section>

        <footer style="background: #333; color: white; padding: 2rem; text-align: center;">
            <p>&copy; 2025 Mr. Electronic.</p>
            <p style="margin-top: 10px; font-size: 0.8rem; cursor: pointer; color: #aaa;" onclick="openLoginModal()">Admin Login</p>
        </footer>
    </div>

    <div id="admin-view" class="hidden">
        <div class="admin-header">
            <div class="logo" style="color: white; font-size: 1.5rem;">Mr. Electronic <span style="font-size: 1rem; opacity: 0.7;">| Admin Dashboard</span></div>
            <button onclick="logoutAdmin()" class="btn" style="background: rgba(255,255,255,0.2);">Logout</button>
        </div>

        <div class="container admin-table-container">
            <h2 style="margin-bottom: 20px;">Current Bookings</h2>
            <div id="adminTableContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="bookingModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeBooking()">&times;</span>
            <h2 style="color: var(--primary); margin-bottom: 10px;">Book Slots</h2>
            <p id="planNameDisplay" style="color: #666; margin-bottom: 20px;"></p>
            
            <form id="bookingForm" onsubmit="handlePayment(event)">
                <input type="hidden" id="selectedPlanPrice">
                <input type="hidden" id="selectedPlanDuration">
                <input type="hidden" id="selectedPlanName">

                <div class="form-group">
                    <label>Booker Name:</label>
                    <input type="text" id="bookerName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label>Email Address:</label>
                    <input type="email" id="bookerEmail" required placeholder="name@example.com">
                </div>
                <div class="form-group">
                    <label>Select Start Date:</label>
                    <input type="text" id="datePicker" required placeholder="Select a date..." readonly>
                    <div id="dateDisplay" style="margin-top:5px; font-size:0.9rem; color:var(--primary);"></div>
                </div>
                <div class="form-group">
                    <label>Number of Candidates:</label>
                    <input type="number" id="candidateCount" min="1" value="1" required oninput="calculateTotal()">
                </div>
                <div style="background:#f9f9f9; padding:15px; border-radius:5px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Rate:</span><span id="rateDisplay"></span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; border-top:1px solid #ddd; padding-top:5px;"><span>Total Payable:</span><span id="totalDisplay">₹0</span></div>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Pay & Book</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-modal" onclick="closeLoginModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--primary);">Admin Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><input type="text" id="adminUser" placeholder="Username" required></div>
                <div class="form-group"><input type="password" id="adminPass" placeholder="Password" required></div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
                <p id="loginError" style="color:red; margin-top:10px; display:none;">Invalid Credentials!</p>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // --- LOGIC ---
        const DB_KEY = 'mr_electronic_bookings_db';
        let calendarInstance = null;

        function getBookings() { return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); }
        function saveBookings(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }

        // Auth
        function openLoginModal() { document.getElementById('loginModal').style.display = 'flex'; }
        function closeLoginModal() { document.getElementById('loginModal').style.display = 'none'; }
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if(u === 'Maharajan' && p === '123456') { closeLoginModal(); switchView('admin'); document.getElementById('adminUser').value=''; document.getElementById('adminPass').value=''; document.getElementById('loginError').style.display='none'; }
            else { document.getElementById('loginError').style.display = 'block'; }
        }
        function logoutAdmin() { switchView('user'); }
        function switchView(view) {
            const userView = document.getElementById('user-view');
            const adminView = document.getElementById('admin-view');
            if(view === 'admin') { userView.classList.add('hidden'); adminView.classList.remove('hidden'); renderAdminTable(); } 
            else { adminView.classList.add('hidden'); userView.classList.remove('hidden'); }
        }

        // Calendar
        function initCalendar(duration) {
            const bookings = getBookings();
            let disabledDates = [];
            bookings.forEach(b => { disabledDates.push({ from: b.startDate, to: b.endDate }); });
            if(calendarInstance) calendarInstance.destroy();
            calendarInstance = flatpickr("#datePicker", {
                minDate: "today", disable: disabledDates, dateFormat: "Y-m-d",
                onChange: function(selectedDates) { if(selectedDates.length > 0) calculateEndDate(selectedDates[0], duration); }
            });
        }
        function calculateEndDate(startDate, duration) {
            const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + (duration - 1));
            const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('dateDisplay').innerHTML = `<strong>Duration:</strong> ${duration} Days<br>${startDate.toLocaleDateString('en-US', options)} &rarr; ${endDate.toLocaleDateString('en-US', options)}`;
        }

        // Booking
        function openBooking(planName, duration, price) {
            document.getElementById('bookingModal').style.display = 'flex';
            document.getElementById('planNameDisplay').innerText = planName;
            document.getElementById('selectedPlanName').value = planName;
            document.getElementById('selectedPlanDuration').value = duration;
            document.getElementById('selectedPlanPrice').value = price;
            // Reset
            document.getElementById('bookerName').value = ''; document.getElementById('bookerEmail').value = '';
            document.getElementById('candidateCount').value = 1; document.getElementById('dateDisplay').innerText = ''; document.getElementById('datePicker').value = '';
            initCalendar(duration); calculateTotal();
        }
        function closeBooking() { document.getElementById('bookingModal').style.display = 'none'; }
        function calculateTotal() {
            const price = parseInt(document.getElementById('selectedPlanPrice').value);
            const count = parseInt(document.getElementById('candidateCount').value) || 0;
            document.getElementById('rateDisplay').innerText = `₹${price} x ${count}`;
            document.getElementById('totalDisplay').innerText = `₹${price * count}`;
        }
        function handlePayment(e) {
            e.preventDefault();
            const dateStr = document.getElementById('datePicker').value;
            if(!dateStr) { alert("Please select a date."); return; }
            const duration = parseInt(document.getElementById('selectedPlanDuration').value);
            const startDate = new Date(dateStr);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + (duration - 1));

            const bookings = getBookings();
            const isBlocked = bookings.some(b => {
                const bStart = new Date(b.startDate); const bEnd = new Date(b.endDate);
                return (startDate <= bEnd && endDate >= bStart);
            });
            if(isBlocked) { alert("Error: Dates intersect with existing booking."); return; }

            const newBooking = {
                id: Date.now(),
                booker: document.getElementById('bookerName').value,
                email: document.getElementById('bookerEmail').value,
                plan: document.getElementById('selectedPlanName').value,
                candidates: document.getElementById('candidateCount').value,
                amount: document.getElementById('totalDisplay').innerText,
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                status: 'Pending'
            };
            bookings.push(newBooking); saveBookings(bookings);
            alert("Booking Request Sent! Wait for Admin approval."); closeBooking();
        }

        // Admin Table & Sending Email
        function renderAdminTable() {
            const bookings = getBookings();
            const container = document.getElementById('adminTableContent');
            if(bookings.length === 0) { container.innerHTML = '<p style="text-align:center; color:#777; margin-top:30px;">No bookings found.</p>'; return; }
            
            let html = `<table><thead><tr><th>Booker</th><th>Email</th><th>Plan</th><th>Dates</th><th>Status</th><th>Total</th><th>Actions</th></tr></thead><tbody>`;
            bookings.forEach(b => {
                const statusBadge = b.status === 'Confirmed' ? `<span class="badge-confirmed">Confirmed</span>` : `<span class="badge-pending">Pending</span>`;
                const acceptBtn = b.status === 'Pending' ? `<button class="btn btn-success" style="padding:5px 10px; font-size:0.8rem; margin-right:5px;" onclick="acceptBooking(${b.id})">Accept</button>` : '';
                html += `<tr><td><strong>${b.booker}</strong></td><td>${b.email}</td><td>${b.plan}</td><td><small>${b.startDate}<br>to ${b.endDate}</small></td><td>${statusBadge}</td><td style="color:green; font-weight:bold;">${b.amount}</td><td>${acceptBtn}<button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteBooking(${b.id})">Delete</button></td></tr>`;
            });
            html += '</tbody></table>'; container.innerHTML = html;
        }

        async function acceptBooking(id) {
            let bookings = getBookings();
            const booking = bookings.find(b => b.id === id);
            if(!booking) return;

            const adminEmail = prompt("To confirm, enter Admin Email:", "admin@mr-electronic.com");
            if(!adminEmail) return;

            // --- SEND REQUEST TO BACKEND ---
            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: booking.email,
                        booker_name: booking.booker,
                        plan: booking.plan,
                        dates: `${booking.startDate} to ${booking.endDate}`,
                        total: booking.amount
                    })
                });

                const result = await response.json();
                
                if(result.success) {
                    alert("Email Sent Successfully!");
                    booking.status = 'Confirmed';
                    saveBookings(bookings);
                    renderAdminTable();
                } else {
                    alert("Failed to send email. Check Server Console.");
                }
            } catch (err) {
                alert("Error connecting to server. Is 'node server.js' running?");
                console.error(err);
            }
        }

        function deleteBooking(id) {
            if(confirm("Delete this booking?")) {
                let bookings = getBookings();
                bookings = bookings.filter(b => b.id !== id);
                saveBookings(bookings);
                renderAdminTable();
            }
        }

        window.onclick = function(e) {
            if(e.target == document.getElementById('bookingModal')) closeBooking();
            if(e.target == document.getElementById('loginModal')) closeLoginModal();
        }
    </script>
</body>
</html>